<!DOCTYPE html>
<html>
<head>
  <title>Flex Notes</title>
  <style>
    body {
      color: #EEE;
      font-size: 20px;
      font-family: Arial, sans-serif;
      padding:0;
      margin:0;
      overflow:scroll;
    }
    
    #sn-main {
      display: grid;
      grid-template-columns: 1fr;
      padding:0;
      margin:0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    
    .sn-row {
      width: 100vw;
      height: 100%;
      display: grid;
      grid-template-rows: 1fr;
    }
    
    .sn-area {
      border-radius:0;
      resize: none;
      font-size: inherit;
      width: 1fr;
      height: 1fr;
      border: 3px black solid;
      padding: 5px;
    }
    
    .sn-row-cont {
      display:flex;
      algin-items:center;
      align-content:center;
      min-height: 0;
      max-width: 150vw;
    }
    
    .sn-add {
      background: linear-gradient(to top right, blue, #7db1ff);
      color: white;
      border: darkblue 2px solid;
      box-shadow: 0px 0px 20px lightblue;
      font-size: 45px;
      border-radius: 50px;
      width: 50px;
      height: 50px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 5px;
      transition: transform .3s ease;
    }
    
    .sn-add-red {
      background: linear-gradient(to top right, #ad0202, #ff5c5c);
      border-color: #850505;
    }
    
    .sn-row-add .sn-add {
      	transform: translateX(120%);
    }
    
    .sn-row-add {
    	display:flex;
    	flex-direction: column;
    	justify-content: center;
    	/*right: 10px; calc - 10px)*/
      	transform:translate(-100%, 0%);
      	padding-right: 10px;
      	background: linear-gradient(to left, rgba(0,0,0,0.5), rgba(0,0,0,0));
      	opacity:0;
      	transition: opacity .3s linear;
    }
    
    .sn-col-add .sn-add {
      	transform: translateY(150%);
    }
    
    .sn-col-add {
    	display:flex;
    	justify-content:center;
    	width: 100%;
    	bottom: 0px;
    	padding-bottom: 10px;
    	position: absolute;
    	opacity: 0;
      	background: linear-gradient(to top, rgba(0,0,0,0.5), rgba(0,0,0,0));
      	transition: opacity .3s linear;
      	overflow:hidden;
    }
    
    .sn-row-add:hover {
    	opacity: 1;
    }
    
    .sn-col-add:hover {
    	opacity: 1;
    }
    
    .sn-row-add:hover .sn-add {
    	transform:translateX(0%);
    }
    
    .sn-col-add:hover .sn-add {
    	transform:translateY(0%);
    }
    
    .sn-spacer {
    	position:absolute;top:0;left:0;pointer-events:none;
    }
    
    .sn-divider-cont {
    	width:100vw;transform:translate(0%,-50%);
    	display:flex;
    	align-items:center;
    	justify-content:center;
    	pointer-events: all;
    	cursor: row-resize;
    	position:absolute;
    }
    
    .sn-divider-cont:active .sn-divider {
    	width: 100vw;
    }
    
    .sn-divider-cont:hover .sn-divider {
    	opacity:1;
    }
    
    .sn-divider-cont .sn-divider {
    	width:90vw;
    	opacity:0.75;
    	background: white;
    	height: 3px;
    	transition: width .2s ease-out, opacity .2s ease-out;
    }
    
    /*begin pacifikyneodark*/
    :root {
      --radius: 45px;
      --height: 6px;
    }
    input:focus,select:focus,textarea:focus {outline:none;}
    .button,input,select {font-family: Arial, sans-serif;}
    input:active,select:active,input[type="text"]:focus,.button:active,.sn-slideinp:active .sn-inp-maincont:before {
      box-shadow: 0 -1px 3px rgba(255,255,255,0.4) inset, 0 0 0 rgba(0,0,0,0.2), 0 -6px 10px rgba(255,255,255,0.4) inset, 0 1px 3px rgba(255,255,255,0.1) inset,0 0 0 rgba(0,0,0,0.6), 0 0 0 rgba(240,240,240,0.6), 2px 2px var(--height) rgba(0,0,0,0.6) inset;
    }
    details,input,select,.button,.contsolid,.sn-slideinp .sn-inp-maincont:before {background: linear-gradient(to top left, rgba(255,255,255,0), rgba(255,255,255,0.2)) !important;border:none;box-shadow: 0 1px 3px rgba(255,255,255,0.4) inset, 0 50px 80px rgba(0,0,0,0.2), 0 6px 10px rgba(255,255,255,0.4) inset, 0 -1px 3px rgba(255,255,255,0.1) inset,2px 2px var(--height) rgba(0,0,0,0.6), -2px -2px var(--height) rgba(240,240,240,0.6);}
    input,select,.button {
      transition: box-shadow .15s linear;
      background: none;
      color: currentcolor;
      font-size: 13px;
      padding: 10px;
      margin: 5px 0;
      border-radius: var(--radius);
      min-width:0px;
    }
    select {background-color:#222}
    /*End PacifikyNeoDark*/
    
    h3 {
    	font-weight: normal;
    	font-size: 25px;
    	margin: 5px;
    	text-align:center;
    }
    
    #sn-header-cont {
    	width: 100vw;
    	height: 5px;
    	position:absolute;
    	top:0;
    	left:0;
    }
    
    #sn-header-cont:hover .sn-header {
    	transform: translate(0%,0%);
    	box-shadow: 0 0 10px black;
    }
    
    .sn-header {
    	transform: translate(0%,-100%);
    	transition: transform .3s ease, box-shadow .3s ease;
    	backdrop-filter: brightness(0.5) blur(5px);
    	height: 30px;
    	display:block;
    	width: 100%;
    	display:flex;
    	align-items:center;
    	flex-direction:row;
    }
    
    .sn-header-menu {
    	display: inline-block;
    }
    
    .sn-header-btn {
    	border-radius: 5px;
    	padding: 3px 5px;
    	margin: 2px;
    	border: none;
    	background: none;
    	color: white;
    	transition: background .2s linear;
    }
    
    .sn-header-btn:hover {
    	background: rgba(0,0,0,0.5);
    }
    
    .sn-header-version {
    	margin-left: auto;
    	margin-right: 10px;
    	font-size: 20px;
    }
    
    .sn-modal-cont {
    	position: absolute;
    	top:0;
    	left:0;
    	background: rgba(0,0,0,0.7);
    	width:100vw;
    	height:100vh;
    	display: flex;
    	align-items:center;
    	justify-content:center;
    	transition: opacity .3s ease;
    	z-index: 100;
    }
    
    .sn-modal-cont.hidden {
    	opacity:0;
    	pointer-events:none;
    }
    
    .sn-modal-cont.hidden .sn-modal {
    	transform: scale(0.5);
    }
    
    .sn-modal-cont .sn-modal {
    	height: 60vh;
    	width: 50vw;
    	backdrop-filter: blur(8px);
    	background: linear-gradient(to top right, rgba(255,255,255,0), rgba(255,255,255,0.1));
    	box-shadow: 0 1px 3px rgba(255,255,255,0.4) inset, 0 50px 80px rgba(0,0,0,0.2), 0 6px 10px rgba(255,255,255,0.4) inset, 0 -1px 3px rgba(255,255,255,0.1) inset;
    	border: solid 1px rgba(255,255,255,0.4);
    	border-radius:50px;
    	overflow: hidden;
    	padding: 25px 35px 0 35px;
    	transition: transform .3s ease;
    	max-width: 500px;
    	display:flex;
    	flex-direction:column;
    }
    
    .sn-modal-cont .sn-modal::before {
    	content: '';
    	position:absolute;
    	top:0;
    	left:0;
    	width: 100%;
    	height: 1px;
    	background:linear-gradient(90deg,transparent,rgba(255,255,255,0.8), transparent);
    }
    
    .sn-modal-title {
    	/*font-weight: 600;*/
    	font-size: 30px;
    	color: #EEEEEE;
    }
    
    .sn-modal-div {
    	margin: 10px -50px 0 -50px;
    	opacity: 0.3;
    }
    .sn-numinp {
    	display:inline-flex;
    	flex-direction: column;
    }
    .sn-numinp .sn-inp-maincont {
    	display:flex;
    }
    input[type='number']::-webkit-outer-spin-button,
	input[type='number']::-webkit-inner-spin-button {
  		-webkit-appearance: none;
  		margin: 0;
	}
	.sn-numinp .sn-inp-caption {
		text-align: center;
		margin-bottom: 5px;
	}
    .sn-numinp input[type='number'] {
    	font-size:40px;
    	padding: 10px 10px;
    	width: 50px;
    }
    .sn-numinp-inc {
    	display:inline-flex;
    	flex-direction:column;
    	justify-content:space-between;
    	margin: 0 10px;
    }
    .sn-numinp-inc button {
    	font-size: 30px;
    	width: 30px;
    	height: 30px;
    }
    .sn-icobtn {
    	display:inline-flex;
    	align-items:center;
    	justify-content:center;
    	cursor:pointer;
    }
    .sn-close {
    	font-size: 40px;
    	width: 40px;
    	height: 40px;
    	position: absolute;
    	top: 15px;
    	right: 30px;
    }
    table {
    	border-collapse: collapse;
    	border-spacing: 0;
    	margin-left: auto;
    	margin-right: auto;
    }
    th {border: 3px solid rgba(255,255,255,0.5);padding:5px;}
    td {border: 3px solid rgba(255,255,255,0.2);padding:5px;}
    .sn-modal-scroll {
    	overflow-y: auto;
    	margin: 0 -10px;
    	padding: 10px 10px;
    	min-height: 82%;
    }
    .sn-modal-foot {
    	position:absolute;
    	font-size: 15px;
    	bottom:0px;
    	margin-left:-32px;
    	padding: 30px 0 10px 32px;
    	width:100%;
    	background: linear-gradient(to top,rgba(255,255,255,0.2),transparent);
    	z-index:100;
    	pointer-events:none;
    }
    .sn-slideinp {
    	user-select:none;
    }
    .sn-slideinp .sn-inp-main {
    	display:none;
    }
    .sn-slideinp .sn-inp-maincont {
    	position:relative;
    	padding:0;
    	height:30px;
    	display:flex;
    	align-items:center;
    	margin: 10px 0;
    }
    .sn-slideinp .sn-inp-maincont:before {
    	content: "";
    	width: 50px;
    	height: 30px;
    	transition: box-shadow .15s linear;
    	background: linear-gradient(to top left, rgba(255,255,255,0.1), rgba(255,255,255,0.4)) !important;
    	cursor:pointer;
    	border:none;
    	display:inline-block;
    	border-radius: 15px;
    	margin-right: 10px;
    }
    /*
    .sn-slideinp:active .sn-inp-maincont:before{
        box-shadow: 0 -1px 3px rgba(255,255,255,0.4) inset, 0 50px 80px rgba(0,0,0,0.2), 0 -6px 10px rgba(255,255,255,0.4) inset, 0 1px 3px rgba(255,255,255,0.1) inset;
    }
    */
    .sn-slideinp .sn-inp-caption:before {
    	height:20px;
    	width:20px;
    	content:"";
    	position:absolute;
    	top:5px;
    	left:5px;
    	background: white;
    	box-shadow: 0 0 10px #ff8a8a inset;
    	border-radius:10px;
    	transition: transform .2s ease, box-shadow .2s linear;
    }
    .sn-slideinp .sn-inp-main:checked + .sn-inp-caption:before {
    	transform:translateX(20px);
    	box-shadow: 0 0 10px #00ff55 inset;
    }
    ::placeholder {
    	color:white;
    	opacity:0.3
    }
  </style>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
</head>

<body lang="en">
  <div id='sn-main' style='grid-template-rows: 1fr;font-size:12px'>
    <div class='sn-row-cont'></div>
  </div>
  <div id='sn-over'>
  	<div class='sn-col-add'>
  		<button class='sn-add'>+</button>
  		<button class='sn-add sn-add-red'>-</button>
  	</div>
  	<div id='sn-header-cont'>
  		<div class='sn-header'>
  			<div class='sn-header-menu'>
  				<button class='sn-header-btn' id='sn-file-btn'>Save</button>
  			</div>
  			<div class='sn-header-menu'>
  				<button class='sn-header-btn' id='sn-edit-btn'>Load</button>
  			</div>
  			<div class='sn-header-menu'>
  				<button class='sn-header-btn' id='sn-tabsave-btn'>Load tabsave</button>
  			</div>
  			<div class='sn-header-menu'>
  				<button class='sn-header-btn' id='sn-pref-btn'>Preferences</button>
  			</div>
  			<div class='sn-header-menu'>
  				<button class='sn-header-btn' id='sn-help-btn'>Help</button>
  			</div>
  			<div class='sn-header-version'>
  				v0.1.4 Dev Build
  			</div>
  		</div>
  	</div>
  </div>
  <div id='sn-overlay'>
  	<div id='sn-prefmodal' class='sn-modal-cont hidden'>
  		<div class='sn-modal'>
  			<button class='button sn-close sn-icobtn sn-modal-close'>×</button>
  			<div class='sn-modal-title'>
  				Preferences
  			</div> 
  			<hr class='sn-modal-div'/>
  			<div class='sn-modal-scroll'>
  				<div class='sn-inpinp' title='File name'>
  					<span class='sn-inp-caption'>File name</span>
  					<div class='sn-inp-maincont'>
  						<input class='sn-inp-main sn-form-file' placeholder='export'></input>.fn<br/>
  					</div>
  				</div>
  				<div class='sn-numinp' title='Font size'>
  					<span class='sn-inp-caption'>Font Size</span>
  					<div class='sn-inp-maincont'>
  						<input type='number' class='sn-inp-main sn-form-font' value='12' min='1'></input>
  						<div class='sn-numinp-inc'>
  							<button class='button sn-icobtn'>+</button>
  							<button class='button sn-icobtn'>-</button>
  						</div>
  					</div>
  				</div>
  				<div class='sn-slideinp'>
  					<label class='sn-inp-maincont'>
  						<input type='checkbox' class='sn-inp-main sn-form-tabsave'></input>
  						<span class='sn-inp-caption'>Tabsave</span>
  					</label>
  				</div>
  				<div class='sn-slideinp'>
  					<label class='sn-inp-maincont'>
  						<input type='checkbox' class='sn-inp-main sn-form-encrypt' disabled></input>
  						<span class='sn-inp-caption'>Tabsave Encryption</span>
  					</label>
  				</div>
  				<div class='sn-inpinp' title='Tabsave key'>
  					<span class='sn-inp-caption'>Tabsave key</span>
  					<div class='sn-inp-maincont'>
  						<input class='sn-inp-main sn-form-key' placeholder='frostbyte' disabled></input>
  					</div>
  				</div>
  				<div class='sn-slideinp'>
  					<label class='sn-inp-maincont'>
  						<input type='checkbox' class='sn-inp-main sn-form-autosave'></input>
  						<span class='sn-inp-caption'>Autosave</span>
  					</label>
  				</div>
  				<div class='sn-numinp' title='Autosave interval (Minutes)'>
  					<span class='sn-inp-caption'>Autosave Interval (Min)</span>
  					<div class='sn-inp-maincont'>
  						<input type='number' class='sn-inp-main sn-form-min' value='5' min='1'></input>
  						<div class='sn-numinp-inc'>
  							<button class='button sn-icobtn'>+</button>
  							<button class='button sn-icobtn'>-</button>
  						</div>
  					</div>
  				</div>
  			</div>
  			<span class='sn-modal-foot'>© 2025 Pacifiky. ||| CC BY-NC-SA 4.0</span>
  		</div>
  	</div>
  	<div id='sn-helpmodal' class='sn-modal-cont hidden'>
  		<div class='sn-modal'>
  			<button class='button sn-close sn-icobtn sn-modal-close'>×</button>
  			<div class='sn-modal-title'>
  				Help
  			</div> 
  			<hr class='sn-modal-div'/>
  			<div class='sn-modal-scroll'>
  				<h3>Shortcuts</h3>
  				<table>
          			<thead>
            			<tr>
              			<th>Shortcut</th>
              			<th>Context</th>
              			<th>Result</th>
            			</tr>
          			</thead>
          			<tbody>
            			<tr>
              			<td>Ctrl+?</td>
              			<td>Global</td>
              			<td>Open help</td>
            			</tr>
            			<tr>
              			<td>Ctrl+s</td>
              			<td>Global</td>
              			<td>Save file</td>
            			</tr>
            			<tr>
              			<td>Ctrl+i</td>
              			<td>Global</td>
              			<td>Import file</td>
            			</tr>
            			<tr>
              			<td>Ctrl+p</td>
              			<td>Global</td>
              			<td>Open preferences</td>
            			</tr>
              			<td>Ctrl+j</td>
              			<td>Global</td>
              			<td>Add row</td>
            			</tr>
              			<td>Ctrl+k</td>
              			<td>Global</td>
              			<td>Remove row</td>
            			</tr>
          			</tbody>
        		</table>
        	</div>
  		</div>
  	</div>
  </div>
  <script>
  	/*
  	TBD:
  	Implement CryoCrypt and fsort for Rust wasm 
  Update file format for unicode support
  	*/
  	const numbInputs = document.getElementsByClassName('sn-numinp');
  	for(let i=0;i<numbInputs.length;i++){
  		const inp = numbInputs[i].getElementsByClassName('sn-inp-main')[0];
  		const inc = numbInputs[i].getElementsByClassName('sn-numinp-inc')[0];
  		inc.children[0].addEventListener('click',()=>{
  			const val = parseInt(inp.value);
  			if(!inp.max || val < inp.max){
  				inp.value = val+1;
  				inp.dispatchEvent(new Event('change'));
  			}
  		})
  		inc.children[1].addEventListener('click',()=>{
  			const val = parseInt(inp.value);
  			if(!inp.min || val > inp.min){
  				inp.value = val-1;
  				inp.dispatchEvent(new Event('change'));
  			}
  		})
  	}
  	const snModals = document.getElementsByClassName('sn-modal-cont');
  	for(let i=0;i<snModals.length;i++){
  		snModals[i].getElementsByClassName('sn-modal-close')[0].addEventListener('click',()=>{
  			snModals[i].classList.add('hidden');
  		});
  	}
  	
  	const cont = document.getElementById('sn-main');
  	const over = document.getElementById('sn-over');
  	const prefModal = document.getElementById('sn-prefmodal');
  	const helpModal = document.getElementById('sn-helpmodal');
  	const prefFile = prefModal.getElementsByClassName('sn-form-file')[0];
  	const prefTabSave = prefModal.getElementsByClassName('sn-form-tabsave')[0];
  	let rowLengths = [parseFloat(cont.style.gridTemplateRows.split(' ')[0])];
  	const baseParams = {alphabet:'base64url',omitPadding:true};
  	let rows = [];
  	let dividers = [];
  	let asInterval = null;
  	let winSave = null;
  	let C_prevState = {
  		val: [['']],
  		cont: cont.style.gridTemplateRows,
  	};
  	function bindToTabSave(a){
  		a.addEventListener('change',updateTabSave);
  	}
  	class SNRow {
  		constructor(elm){
  			this.add = this.add.bind(this);
  			this.rem = this.rem.bind(this);
  			this.cont = elm;
  			this.row = document.createElement('div');
  			this.row.classList.add('sn-row');
  			this.row.style.gridTemplateColumns = '1fr';
  			this.cont.appendChild(this.row)
  			const initArea = document.createElement('textarea');
  			initArea.classList.add('sn-area');
  			this.row.appendChild(initArea);
  			bindToTabSave(initArea);
  			this.areas = [initArea];
  			const addCont = document.createElement('div');
  			addCont.classList.add('sn-row-add');
  			this.cont.appendChild(addCont);
  			this.addBtn = document.createElement('button');
  			this.addBtn.classList.add('sn-add');
  			this.addBtn.appendChild(document.createTextNode('+'));
  			addCont.appendChild(this.addBtn);
  			this.remBtn = document.createElement('button');
  			this.remBtn.className = 'sn-add sn-add-red';
  			this.remBtn.appendChild(document.createTextNode('-'));
  			addCont.appendChild(this.remBtn);
  			this.addBtn.addEventListener('click',this.add);
  			this.remBtn.addEventListener('click',this.rem);
  		}
  		add(){
  			const newArea = document.createElement('textarea');
  			newArea.classList.add('sn-area');
  			this.row.appendChild(newArea);
  			bindToTabSave(newArea);
  			this.areas.push(newArea);
  			this.row.style.gridTemplateColumns = '1fr';
  			for(let i=1;i<this.areas.length;i++){
  				this.row.style.gridTemplateColumns += ' 1fr';
  			}
  		}
  		rem(){
  			if(this.areas.length == 1 || !(confirm('Are you sure you want to delete the textarea?'))){return;}
  			const remArea = this.areas.pop();
  			remArea.remove();
  			this.row.style.gridTemplateColumns = '1fr';
  			for(let i=1;i<this.areas.length;i++){
  				this.row.style.gridTemplateColumns += ' 1fr';
  			}
  		}
  	}
  	
  	function addCol(){
  		const divy = 1/(rows.length+1);
  		const rowFrs = cont.style.gridTemplateRows.split(' ');
  		const rowElms = Array.from(cont.children);
  		rowLengths.length = 0;
  		//alert(rowFrs);
  		for(let i=0;i<rowFrs.length;i++){
  			rowFrs[i] = parseFloat(rowFrs[i]); //*rowFrs.length
  		}
  		const otherScale = 1-divy;
  		//alert(rowFrs);
  		let newStyle = '';
  		for(let i=0;i<rowFrs.length;i++){
  			if(isNaN(rowFrs[i])){continue;}
  			rowLengths.push(rowFrs[rowElms.indexOf(rows[i].cont)]*otherScale) //divy*
  			newStyle += rowLengths[rowLengths.length-1].toString()+'fr ';
  			//alert(rowElms.indexOf(rows[i].cont))
  		}
  		rowLengths.push(divy);
   		const newCol = document.createElement('div');
  		newCol.classList.add('sn-row-cont');
  		cont.appendChild(newCol);
  		rows.push(new SNRow(newCol));
  		newStyle += divy.toString()+'fr';
  		cont.style.gridTemplateRows = newStyle;
  		
  		//updRowHeight();
  		/*
  		let down = 0;
  		for(let i=0;i<rowFrsNew.length;i++){
  			const test = document.createElement('div');
  			test.style = 'height:50px;width:50px;background:green;position:absolute;';
  			down += (rowFrsNew[i]*window.innerHeight);
  			test.style.top = (down).toString()+'px';
  			document.body.appendChild(test);
  		}
  		*/
  		//alert(rowLengths)
  		let downDist = 0;
  		for(let i=0;i<dividers.length;i++){
  			downDist += rowLengths[i];
  			dividers[i].style.paddingTop = (downDist*100).toString()+'vh';
  		}
  		downDist += rowLengths[dividers.length];
  		const divInd = rowLengths.length-1;
  		addDiv(downDist,divInd);
  	}
  	
  	function remCol(){
  		//try{
  		if(rows.length == 1 || !confirm('Are you sure you want to delete the last column?')){return;}
  			
  		(rows.pop()).cont.remove();
  		(dividers.pop()).remove();
  		
  		const rowFrs = cont.style.gridTemplateRows.split(' ');
  		const divy = 1/rows.length;
  		const rowElms = Array.from(cont.children);
  		
  		rowLengths.length = 0;
  		for(let i=0;i<rowFrs.length;i++){
  			rowFrs[i] = parseFloat(rowFrs[i]);
  		}
  		let otherScale = 1-rowFrs[rowFrs.length-1];
  		let newStyle = '';
  		for(let i=0;i<rows.length;i++){
  			rowLengths.push(rowFrs[rowElms.indexOf(rows[i].cont)]/otherScale)
  			newStyle += rowLengths[rowLengths.length-1].toString()+'fr ';
  		}
  		cont.style.gridTemplateRows = newStyle;
  		
  		let downDist = 0;
  		for(let i=0;i<dividers.length;i++){
  			downDist += rowLengths[i];
  			dividers[i].style.paddingTop = (downDist*100).toString()+'vh';
  		}
  		
  		//}catch(e){alert(e.stack)}
  	}
  	
  	function addDiv(prevLen,row){
  		const contOver = document.createElement('div');
  		contOver.classList.add('sn-spacer');
  		contOver.style.paddingTop = (prevLen*100).toString()+'vh';
  		const divCont = document.createElement('div');
  		divCont.classList.add('sn-divider-cont')
  		const divider = document.createElement('div');
  		divider.classList.add('sn-divider')
  		divCont.appendChild(divider);
  		contOver.appendChild(divCont);
  		document.body.appendChild(contOver);
  		dividers.push(contOver);
  		let divDwn = false;
  		divCont.addEventListener('mousedown',()=>divDwn=true);
  		document.body.addEventListener('mouseup',()=>divDwn=false);
  		document.body.addEventListener('mousemove',e=>{
  			if(divDwn){
  				let initSpace = 0;
  				for(let i=0;i<row-1;i++){
  					initSpace += rowLengths[i];
  				}
  				const newdist = Math.max(e.clientY/window.innerHeight,0.05+initSpace);
  				contOver.style.paddingTop = (newdist*100).toString()+'vh';
  				const fullSize = rowLengths[row]+rowLengths[row-1];
  				rowLengths[row-1] = newdist-initSpace;
  				rowLengths[row] = fullSize-(newdist-initSpace);
  				let newStyle = '';
  				for(let i=0;i<rowLengths.length;i++){
  					newStyle += rowLengths[i].toString()+'fr ';
  				}
  				cont.style.gridTemplateRows = newStyle;
  			}
  		});
  	}
  	
  	function saveConfig(){
  		/*
  		8 0xe588984046521a57 Magic number
  		2 i16 version
  		2 i16 row count
  		4 f32 (xrows) row size
  		2 i16 row 1 column count
  		4 i32 r1c1 byte count
  		- letters
  		4 i32 r1c2 byte count
  		- letters
  		...
  		2 i16 row 2 column count
  		...
  		*/
  		commitChange();
  		let totCol = 0;
  		let totTxt = 0;
  		for(let i=0;i<rows.length;i++){
  			totCol+=rows[i].areas.length;
  			for(let j=0;j<rows[i].areas.length;j++){
  				totTxt += rows[i].areas[j].value.length;
  			}
  		}
  		//alert(12+(6*rows.length)+(4*totCol)+totTxt);
  		//try{
  		const file = new ArrayBuffer(12+(6*rows.length)+(4*totCol)+totTxt); //8+2+2+(4*rows)+(2*rows)+(4*columns)+letters
  		const fileView = new DataView(file);
  		const fileArr = new Uint8Array(file);
  		fileView.setBigUint64(0,16539637033343261271n);
  		fileView.setUint16(8,1);
  		fileView.setUint16(10,rows.length);
  		let ind = 12;
  		const rowFrs = cont.style.gridTemplateRows.split(' ');
  		for(let i=0;i<rowFrs.length;i++){
  			fileView.setFloat32(ind,parseFloat(rowFrs[i]));
  			ind += 4;
  		}
  		const te = new TextEncoder();
  		for(let i=0;i<rows.length;i++){
  			fileView.setUint16(ind,rows[i].areas.length);
  			ind += 2;
  			for(let j=0;j<rows[i].areas.length;j++){
  				fileView.setUint32(ind,rows[i].areas[j].value.length);
  				ind+=4;
  				fileArr.set(te.encode(rows[i].areas[j].value),ind);
  				ind+=rows[i].areas[j].value.length;
  			}
  		}
  		const dwnAnch = document.createElement('a');
  		dwnAnch.download = (prefFile.value||'export')+'.fn';
  		dwnAnch.href = URL.createObjectURL(new Blob([file]));
  		dwnAnch.click();
  		URL.revokeObjectURL(dwnArch.href);
  		//}catch(e){alert(e.stack)}
  	}
  	
  	function loadConfig(){
  		if(!confirm('Are you sure you want to load a file? (Your work will be replaced!)')){return;}
  		const fileInp = document.createElement('input');
  		fileInp.type = 'file';
  		fileInp.accept = '.fn';
  		fileInp.addEventListener('change',()=>{
  			fileInp.remove();
  			if(fileInp.files.length == 0){
				alert('Please upload some files');
				return;
			}
			prefFile.value = fileInp.files[0].name.substr(0,fileInp.files[0].name.length-3);
			const fR = new FileReader();
			fR.onload = ()=>{
				const file = fR.result;
				const fileView = new DataView(file);
				if(fileView.getBigUint64(0) != 16539637033343261271n){alert('Invalid File!');return;};
				if(fileView.getUint16(8) > 1){alert('Invalid File!');return;}
				const rowCount = fileView.getUint16(10);
				let ind = 12;
				
				for(let i=0;i<rows.length;i++){
					rows[i].cont.remove();
				}
				for(let i=0;i<dividers.length;i++){
					dividers[i].remove();
				}
				rowLengths.length = 0;
				rows.length = 0;
				dividers.length = 0;
				let newStyle = '';
				let prevLen = 0;
				for(let i=0;i<rowCount;i++){
					rowLengths.push(fileView.getFloat32(ind));
					newStyle += rowLengths[rowLengths.length-1].toString()+'fr ';
					
					const newCol = document.createElement('div');
  					newCol.classList.add('sn-row-cont');
  					cont.appendChild(newCol);
  					rows.push(new SNRow(newCol));
  					
  					if(i>0) addDiv(prevLen,i);
  					
					ind += 4;
					prevLen += rowLengths[rowLengths.length-1];
				}
				cont.style.gridTemplateRows = newStyle;
				
				const td = new TextDecoder();
				for(let i=0;i<rowCount;i++){
					const colCount = fileView.getUint16(ind);
					ind += 2;
					for(let j=0;j<colCount;j++){
						//mar:problem This doesn't account for unicode!!
						const newText = new Uint8Array(new ArrayBuffer(fileView.getUint32(ind)));
						ind+=4;
						for(let i=0;i<newText.buffer.byteLength;i++){
							newText[i] = fileView.getUint8(ind);
							ind++;
						}
						if(j!=0){rows[i].add()};
						rows[i].areas[j].value = td.decode(newText);
					}
				}
				checkForChange(false);
			}
			fR.readAsArrayBuffer(fileInp.files[0]);
  		});
  		fileInp.click();
  	}
  	function commitChange(){
  		C_prevState.cont = cont.style.gridTemplateRows;
  		C_prevState.val = new Array(rows.length);
  		for(let i=0;i<rows.length;i++){
  			C_prevState.val[i] = new Array(rows[i].areas.length);
  			for(let j=0;j<rows[i].areas.length;j++){
  				C_prevState.val[i][j] = rows[i].areas[j].value;
  			}
  		}
  	}
  	
  	function checkForChange(r=true){
  		if(C_prevState.cont != cont.style.gridTemplateRows || rows.length != C_prevState.val.length){
  			r || commitChange();
  			r && saveConfig();
  			return;
  		}
  		for(let i=0;i<rows.length;i++){
  			if(rows[i].areas.length != C_prevState.val[i].length){
  				r || commitChange();
  				r && saveConfig();
  				return;
  			}
  			for(let j=0;j<rows[i].areas.length;j++){
  				if(rows[i].areas[j].value != C_prevState.val[i][j]){
  					r || commitChange();
  					r && saveConfig();
  					return;
  				}
  			}
  		}
  	}
  	
  	function updateTabSave(){
  		//try{
  		if(!winSave) return;
  		if(winSave.closed) winSave=open();
  		let out = '';
  		const fileName = encodeURIComponent(prefFile.value || 'export');
  		out+=fileName.length.toString(16).padStart(2,'0')+fileName;
  		let totCol = 0;
  		for(let i=0;i<rows.length;i++){
  			totCol+=rows[i].areas.length;
  		}
  		let fullText = '';
  		for(let i=0;i<rows.length;i++){
  			for(let j=0;j<rows[i].areas.length;j++){
  				fullText+=rows[i].areas[j].value;
  			}
  		}
  		fullText = (new TextEncoder()).encode(fullText);
  		/*
  		i16 version
  		i8 flags
  		i16 row count
  		f32 row size
  		i16 r1 column count
  		i32*columns length
  		f32 row size
  		i16 r2 column count
  		i32*columns length
  		*/
  		const file = new Uint8Array(5+rows.length*6+totCol*4+fullText.length);
  		const fileView = new DataView(file.buffer);
  		//File version already set to 0
  		file[2] = 1;
  		fileView.setUint16(3,rows.length);
  		let ind=5;
  		for(let i=0;i<rows.length;i++){
  			fileView.setFloat32(ind,rowLengths[i]);
  			ind+=4;
  			fileView.setUint16(ind,rows[i].areas.length);
  			ind+=2;
  			for(let j=0;j<rows[i].areas.length;j++){
  				fileView.setUint32(ind,rows[i].areas[j].value.length);
  				ind+=4;
  			}
  		}
  		//although encodeURIComponent is the raw string, it can 3x text in worst case and the more spaces, the worse.
  		//base64 is always 1.33, way better than the 2.-x of spaces and special characters of the string
  		file.set(fullText,ind);
  		const fileBase = file.toBase64(baseParams);
  		//Wait I don't need this lol (end) 
  		//out+=(new Uint8Array((new Uint32Array([fileBase.length])).buffer)).toBase64(baseParams);
  		out+=fileBase;
  		winSave.location.href = 'http://fn/'+out;
  		//}catch(e){console.error(e.stack)}
  	}
  	
  	function loadTabSave(){
  		const fullUrl = prompt('Enter Tabsave Url:');
  		if(fullUrl){
  			let fullUrlUrl=null;
  			try{
  				fullUrlUrl = new URL(fullUrl);
  			}catch(e){
  				alert('That\'s not a url!');
  				return;
  			}
  			if(fullUrlUrl.hostname!='fn'){alert('This is not a tabsave URL!');return}
  			const fileNameLength = parseInt(fullUrlUrl.pathname.substr(1,2),16);
  			try{
    		prefFile.value=decodeURIComponent(fullUrlUrl.pathname.substr(3,fileNameLength));
  			//const fileLength = (new Uint32Array(Uint8Array.fromBase64(fullUrlUrl.pathname.substr(3+fileNameLength,6)).buffer))[0];
  			const file = Uint8Array.fromBase64(fullUrlUrl.pathname.substr(3+fileNameLength),baseParams);
  			const fileView = new DataView(file.buffer);
  			if(fileView.getUint16(0)>0){alert('Invalid version!');return}
  			//ignore flags until you add encryption!
  			const rowCount = fileView.getUint16(3);
  			for(let i=0;i<rows.length;i++){
				rows[i].cont.remove();
			}
			for(let i=0;i<dividers.length;i++){
				dividers[i].remove();
			}
			rowLengths = new Array(rowCount);
			rows = new Array(rowCount);
			dividers.length = 0;
			let newStyle = '';
			let ind = 5;
			let prevLen = 0;
			const colLengths = new Array(rowCount);
			for(let i=0;i<rowCount;i++){
				colLengths[i] = [];
				rowLengths[i] = fileView.getFloat32(ind);
				newStyle += rowLengths[i].toString()+'fr ';
				ind+=4;
				const columnCount = fileView.getUint16(ind);
				ind+=2;
				
				const newCol = document.createElement('div');
  				newCol.classList.add('sn-row-cont');
  				rows[i] = new SNRow(newCol);
				for(let j=0;j<columnCount;j++){
					j>0 && rows[i].add();
					colLengths[i].push(fileView.getUint32(ind));
					ind+=4;
				}
  				cont.appendChild(newCol);
  				
  				if(i>0) addDiv(prevLen,i);
				prevLen += rowLengths[i];
			}
			cont.style.gridTemplateRows = newStyle;
			const extractedText = (new TextDecoder()).decode(file.subarray(ind));
			ind = 0;
			for(let i=0;i<rowCount;i++){
				for(let j=0;j<rows[i].areas.length;j++){
					rows[i].areas[j].value = extractedText.substr(ind,colLengths[i][j]);
					ind+=colLengths[i][j];
				}
			}
  			}catch(e){alert(e.stack)}
  		}
  	}
  	
  	const prefFont = prefModal.getElementsByClassName('sn-form-font')[0];
  	prefFont.addEventListener('change',()=>{
  		const cVal = Math.max(1,parseInt(prefFont.value)) || 1;
  		prefFont.value = cVal;
  		cont.style.fontSize = cVal.toString() + 'px';
  	})
  	const prefAutoMin = prefModal.getElementsByClassName('sn-form-min')[0];
  	prefAutoMin.addEventListener('change',()=>{
  		if(prefAutoSave.checked){
  			clearInterval(asInterval);
  			asInterval = setInterval(checkForChange,parseFloat(prefAutoMin.value)*60000);
  		}
  	});
  	const prefAutoSave = prefModal.getElementsByClassName('sn-form-autosave')[0];
  	prefAutoSave.addEventListener('change',()=>{
  		if(prefAutoSave.checked){
  			//make it cancel if no change!
  			asInterval = setInterval(checkForChange,parseFloat(prefAutoMin.value)*60000);
  		}else{
  			clearInterval(asInterval);
  		}
  	});
  	prefTabSave.addEventListener('change',()=>{
  		if(prefTabSave.checked){
  			winSave = open();
  			updateTabSave();
  		}else if(winSave){
  			!winSave.closed && winSave.close()
  			winSave = null;
  		}
  	});
  	const prefEncrypt = prefModal.getElementsByClassName('sn-form-encrypt')[0];
  	const prefKey = prefModal.getElementsByClassName('sn-form-key')[0];
  	const colAddBtn = document.getElementsByClassName('sn-add')[0];
  	colAddBtn.addEventListener('click',addCol);
  	const colRemBtn = document.getElementsByClassName('sn-add-red')[0];
  	colRemBtn.addEventListener('click',remCol);
  	const fileBtn = document.getElementById('sn-file-btn');
  	fileBtn.addEventListener('click',saveConfig);
  	const editBtn = document.getElementById('sn-edit-btn');
  	editBtn.addEventListener('click',loadConfig);
  	const prefBtn = document.getElementById('sn-pref-btn');
  	const helpBtn = document.getElementById('sn-help-btn');
  	prefBtn.addEventListener('click',()=>prefModal.classList.remove('hidden'));
  	helpBtn.addEventListener('click',()=>helpModal.classList.remove('hidden'));
  	const tabSaveBtn = document.getElementById('sn-tabsave-btn');
  	tabSaveBtn.addEventListener('click',loadTabSave);
  	const i_rows = document.getElementsByClassName('sn-row-cont');
  	for(let i=0;i<i_rows.length;i++){
  		rows.push(new SNRow(i_rows[i]))
  	}
  	//updRowHeight();
  	document.addEventListener('keydown',e=>{
  		if(e.ctrlKey){
  			switch(e.key){
  				case 's':
  				e.preventDefault();
  				saveConfig();
  				break;
  				case 'i':
  				loadConfig();
  				break;
  				case 'j':
  				e.preventDefault();
  				addCol();
  				break;
  				case 'k':
  				e.preventDefault();
  				remCol();
  				break;
  				case 'p':
  				e.preventDefault();
  				prefModal.classList.toggle('hidden');
  				break;
  				case '/':
  				e.preventDefault();
  				helpModal.classList.toggle('hidden');
  				break;
  			}
  		}else{
  			switch(e.key){
  				case 'Escape':
  				for(let i=0;i<snModals.length;i++){
  					snModals[i].classList.add('hidden');
  				}
  				break;
  			}
  		}
  	});
  	window.onbeforeunload=()=>{if(rows.length>1){return 0};if(rows[0].areas.length>1){return 0};if(rows[0].areas[0].value.length>0){return 0}};
  </script>
</body>
</html>